<div ng-if="(record | findMaster) && ((record | findMaster).subformat||[]).length < 1" id="announcement" class="alert text-center alert-warning">
  The video might not be playing correctly at the moment due to video formats not yet created. Please try again later.
</div>
<div class="cds-detail-video cds-detail-video-wrapper bg-n pb-20">
  <!-- Video Section -->
  <div ng-if="record.metadata.recid && (record | findMaster).key" class="bg-b">
    <div ng-class="{ 'container-fluid': showInThisVideoSection }" class="video-section" id="videoPlayerSection">
      <div ng-class="{ 'row': ((record.metadata._files | filter:{context_type:'subtitle', content_type:'vtt'}).length > 0 || chapters.length > 0) && showInThisVideoSection }">
        <div ng-class="{ 'col-md-8 pt-20': ((record.metadata._files | filter:{context_type:'subtitle', content_type:'vtt'}).length > 0 || chapters.length > 0) && showInThisVideoSection }">
          <div class="cds-video-iframe text-center">
            <iframe scrolling="no"
                    width="100%"
                    height="100%"
                    frameborder="0"
                    ng-src="{{ '' | previewIframeSrc: record.metadata.recid:(record | findMaster).key }}"
                    allowfullscreen>
            </iframe>
          </div>
        </div>

        <!-- Section In this video -->
        <div ng-show="((record.metadata._files | filter:{context_type:'subtitle', content_type:'vtt'}).length > 0 || chapters.length > 0) && showInThisVideoSection" 
          class="col-md-4 bg-b pt-20"
          id="inThisVideoSection">
          <div class="in-this-video-panel bg-w pl-10 pb-10 pr-10 pt-10">
            <div class="cds-detail-title cds-detail-video-title">
              <h3 class="bt bw-1 pt-10 mb-0">
                <i class="fa fa-video-camera"></i> In this video
                <div class="pull-right"><i class="fa fa-close transcription-close" ng-click="toggleInThisVideo()"></i></div>
              </h3>
            </div>
            <!-- Tabs -->
            <div class="tabs-container">
              <ul class="nav nav-tabs">
                <li ng-class="{ 'active': activeTab === 'chapters' }" ng-if="chapters.length > 0">
                  <a href="javascript:void(0)" ng-click="setActiveTab('chapters')">
                    <i class="fa fa-list-ol"></i> Chapters
                  </a>
                </li>
                <li ng-class="{ 'active': activeTab === 'transcript' }" ng-if="(record.metadata._files | filter:{context_type:'subtitle', content_type:'vtt'}).length > 0">
                  <a href="javascript:void(0)" ng-click="setActiveTab('transcript')">
                    <i class="fa fa-align-left"></i> Transcript
                  </a>
                </li>
              </ul>
            </div>
            <!-- /Tabs -->
            <!-- Transcript Tab -->
            <div ng-show="activeTab === 'transcript' && (record.metadata._files | filter:{context_type:'subtitle', content_type:'vtt'}).length > 0" class="transcript-content">
              <div class="search-container">
                <input type="text"
                    class="form-control"
                    placeholder="Search transcript..."
                    ng-model="transcriptSearch"
                    ng-change="filterTranscript()">
              </div>
              <div ng-show="filteredTranscript.length > 0" class="content-container">
                <ul class="list-unstyled mb-0">
                  <li ng-repeat="line in filteredTranscript"
                      ng-click="seekTo(line.start)"
                      class="transcript-line transcript-item"
                      ng-class="{ 'active': currentTranscriptLine === line }">
                      <div class="transcript-timestamp">
                        {{ convertToMinutesSeconds(line.start) }} - {{ convertToMinutesSeconds(line.end) }}
                      </div>
                      <div class="transcript-text">
                        {{ line.text }}
                      </div>
                  </li>
                </ul>
              </div>
              <div class="form-group language-selector">
                <label>Transcript Language:</label>
                <select
                  class="form-control"
                  ng-model="selectedTranscriptLanguage"
                  ng-options="lang as (lang | isoToLanguage) for (lang, _) in transcriptsByLanguage"
                  ng-change="setTranscriptLanguage(selectedTranscriptLanguage)">
                </select>
              </div>
            </div>
            <!-- /Transcript Tab -->
            <!-- Chapters Tab -->
            <div ng-show="activeTab === 'chapters' && chapters.length > 0" class="content-container">
              <ul class="list-unstyled mb-0">
                <li ng-repeat="chapter in chapters"
                    ng-click="seekTo(chapter.seconds)"
                    class="chapter-item"
                    ng-class="{ 'active': currentChapter === chapter }">
                  <div class="chapter-content">
                    <div class="chapter-thumbnail" ng-init="frame = getChapterFrame(chapter)">
                      <div ng-class="{'is-placeholder': !frame}" class="thumbnail-container">
                        <img 
                          ng-if="frame"
                          ng-src="/api/iiif/v2/{{ frame.bucket_id }}:{{ frame.version_id }}:{{ frame.key }}/full/320,180/0/default.jpg"
                          alt="Chapter {{ chapter.timestamp }}"
                          onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="thumbnail-placeholder" ng-style="{'display': frame ? 'none' : 'flex'}">
                          <i class="fa fa-film"></i>
                        </div>
                      </div>
                    </div>

                    <div class="chapter-info">
                      <div class="chapter-title">
                        {{ cleanHtmlFromTitle(chapter.title) }}
                      </div>
                      <div class="chapter-timestamp">
                        {{ chapter.timestamp }}
                      </div>
                    </div>
                  </div>
                </li>
              </ul>
            </div>
            <!-- /Chapters Tab -->
          </div>
        </div>
      <!-- /Section In this video -->
    </div>
  </div>
  <!-- /Video Section -->
  <!-- Metadata Section -->
  <div class="container-fluid">
    <div class="row">
      <!-- Left Column -->
      <div class="col-md-8">
        <!-- Section -->
        <div class="cds-detail cds-detail-video cds-div-shadow bg-w mt-20 pt-10 pb-10">
          <!-- DOI and report number -->
          <div class="px-20">
            <div class="row">
              <div class="col-md-2">
                <ul ng-show="record.links.project_edit" class="list-inline">
                  <li>
                    <a ng-href="{{ ::record.links.project_edit }}" title="Edit the record"><i class="fa fa-edit"></i> edit</a>
                  </li>
                </ul>
              </div>
              <div class="col-md-10">
                <ul class="list-inline text-right">
                  <li ng-show="record.metadata|isPublic">
                    <span uib-tooltip-html="'This record is <b>public</b>.'" class="label label-success">Public</span>
                  </li>
                  <li ng-hide="record.metadata|isPublic">
                    <span uib-tooltip-html="'This record is <b>restricted</b>.'" class="label label-warning">Restricted</span>
                  </li>
                  <li ng-if="record.metadata.doi">
                    <ng-include src="'/static/templates/cds_records/doi.html'"></ng-include>
                  </li>
                  <li class="pr-0" ng-if="record.metadata.report_number[0]">
                    <ng-include src="'/static/templates/cds_records/report_number.html'"></ng-include>
                  </li>
                </ul>
              </div>
            </div>
          </div>
          <!-- /DOI and report number -->
          <!-- Title -->
          <div class="cds-detail-title cds-detail-video-title mt-20 px-20">
            <hgroup>
              <h1 class="mb-0 mt-0 f4 fw-n t-b">
                {{ ::record.metadata.title.title }}
                <a
                 uib-tooltip-html="'Title and description are available in more languages, please click to see them all.'"
                 ng-show="record.metadata.translations.length > 0"
                 class="f8"
                 ng-click="showTranslations=true">
                  <i class="fa fa-info-circle"></i>
                </a>
              </h1>
              <modal-dialog show="showTranslations" dialog-title="Available translations" >
                <div ng-repeat="translation in record.metadata.translations">
                  <strong>{{translation.language | isoToLanguage}}</strong>
                  <h4>{{translation.title.title}}</h4>
                  <p ng-bind-html="(translation.description | trustHtml) || 'No description'"></p>
                </div>
              </modal-dialog>
            </hgroup>
          </div>
          <!-- /Title -->
          <!-- Date & Views -->
          <div class="cds-detail-date cds-detail-video-date mb-30 px-20 my-20 f8">
            <ul class="list-inline mb-0">
              <li uib-tooltip-html="'Copyright'">
                <i class="fa fa-copyright text-muted"></i> {{ ::record.metadata.copyright.year }} {{ ::record.metadata.copyright.holder }}
              </li>
              <li uib-tooltip-html="'License'" ng-repeat="(material, licenses) in record.metadata.license | groupBy:'material':'other'" ng-if="material == 'other'">
                <i class="fa fa-certificate text-muted"></i>
                <span ng-if="!licenses[0].license">
                  <a ng-click="noLicense = true">Unknown</a>
                  <modal-dialog show="noLicense" dialog-title="Unknown" >
                    <div>
                      <p>
                        This resource is copyrighted as non-CERN and unfortunately we don't have enough information about its licence. None of CERN's terms of use will apply. Please contact the copyright holder directly for more information.
                      </p>
                    </div>
                  </modal-dialog>
                </span>
                <span ng-if="licenses[0].license">
                  <span ng-switch="licenses[0].license">
                    <span ng-switch-when='CERN'>
                      <a target="_blank" href="http://copyright.web.cern.ch/">Conditions of Use</a>
                    </span>
                    <span ng-switch-when='unknown'>
                      <a ng-click="noLicense = true">Unknown Licence</a>
                      <modal-dialog show="noLicense" dialog-title="Unknown Licence" >
                        <div>
                          <p>
                            This resource is copyrighted as non-CERN and unfortunately we don't have enough information about its licence. None of CERN's terms of use will apply. Please contact the copyright holder directly for more information.
                          </p>
                        </div>
                      </modal-dialog>
                    </span>
                    <span ng-switch-default>
                      <a ng-show="licenses[0].url" target="_blank" ng-href="{{ licenses[0].url }}">{{ licenses[0].license }}</a>
                      <span ng-hide="licenses[0].url" >{{ licenses[0].license }}</span>
                    </span>
                  </span>
                </span>
              </li>
              <li uib-tooltip-html="'Date'">
                <i class="fa fa-calendar text-muted"></i> {{ ::record.metadata.date | date:'dd MMMM yyyy' }}
              </li>
              <li uib-tooltip-html="'Video duration'">
                <i class="fa fa-clock-o text-muted"></i> {{ ::record.metadata.duration | replace:'.000':'' }}
              </li>
              <li class="pull-right">
                {{ recordViews || 0 }} Views
              </li>

            </ul>
          </div>
          <hr />
          <!-- Date & Views -->
          <!-- Description -->
          <div ng-init="showFullDescription=false" class="cds-detail-description cds-detail-video-description t-b px-20">
            <p class="mb-30" ng-bind-html="(processDescriptionWithClickableTimestamps(record.metadata.description) | trustHtml) || 'No description'"></p>
            <!-- Hidden content -->
            <div class="mt-20" ng-show="showFullDescription">
              <!-- Contributors -->
              <div class="mb-20">
                <p><strong>Contributors</strong></p>
                <div class="pl-10" ng-repeat="(role, contribs) in record.metadata.contributors | groupBy:'role'">
                  <p>{{ role }}: </p>
                  <ul>
                    <li ng-repeat="contrib in contribs">
                      <a ng-href='/search?q=contributors.name:"{{ contrib.name }}"'>{{ contrib.name }}</a>  {{ contrib.affiliations ? ' - ' + contrib.affiliations.join(',') : ''}}
                    </li>
                  </ul>
                </div>
              </div>
              <!-- Contributors -->
              <div class="mb-10">
                <!-- License -->
                <div class="mb-0" ng-if="record.metadata.license.length > 1">
                  <p><strong>Licences</strong></p>
                  <div class="pl-10" ng-repeat="(material, licenses) in record.metadata.license | groupBy:'material':'other'" ng-if="material != 'other'">
                    <p>{{ material }}:</p>
                    <ul>
                      <li ng-repeat="license in licenses" ng-if="license.license || license.credit">
                        <span ng-if="license.credit">
                            {{ license.credit }}
                        </span>
                        <span ng-if="!license.credit && license.license">
                            <a target="_blank" ng-href='{{ license.url }}'>{{ license.license }}</a>
                        </span>
                      </li>
                    </ul>
                  </div>
                </div>
                <!-- License -->
                <div class="mt-30">
                 <ul class="list-inline pt-20 f8">
                   <li uib-tooltip-html="'Video Language'" ng-if="record.metadata.language">
                      <i class="fa fa-globe text-muted"></i> <a ng-href='/search?q=language:"{{ record.metadata.language }}"'>{{ record.metadata.language | isoToLanguage }}</a>
                   </li>
                   <li ng-if="record.metadata.language && (record.links.project_html || record.metadata._project_id)">
                     ·
                   </li>
                   <li ng-if="record.links.project_html || record.metadata._project_id">
                     <i class="fa fa-list-ul text-muted"></i>
                     <a ng-href="{{ record.links.project_html ? record.links.project_html : '/search?q=_project_id:' + record.metadata._project_id }}">
                       More videos in the project
                     </a>
                   </li>
                 </ul>
               </div>
               <!-- License -->
              </div>
            </div>
            <!-- Related links -->
            <li ng-if="record.metadata.related_links.length > 0">
              <strong>Related links</strong>
              <ul ng-repeat="related_link in record.metadata.related_links">
                <li>
                  <a ng-href='{{ :: related_link.url | absoluteURL }}' target="_blank">{{ related_link.name }}</a>
                </li>
              </ul>
            </li>
            <!-- Related links -->
            <!-- Hidden content -->
            <div ng-show="!showFullDescription" class="text-center">
              <a class="btn btn-link btn-sm" ng-click="showFullDescription=!showFullDescription">{{ showFullDescription ? 'Show less' : 'Show more' }}</a>
            </div>
          </div>
          <!-- /Description -->
          
          <!-- Chapters Section -->
          <div ng-if="chapters.length > 0" class="cds-detail-chapters px-20 mb-10">
            <hr />
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
              <h3><strong>Chapters</strong></h3>
              <button class="btn btn-sm btn-default transcription-button" ng-click="toggleInThisVideo('chapters')">
                {{ showInThisVideoSection ? 'Show Less' : 'View All' }}
              </button>
            </div>
            
            <!-- Horizontal Chapter List -->
            <div class="chapters-main-horizontal" style="overflow-x: auto; overflow-y: hidden; white-space: nowrap;">
              <div style="display: inline-flex; gap: 15px; padding-bottom: 8px; padding-top: 8px;">
                <div ng-repeat="chapter in chapters" 
                     class="chapter-item-horizontal-main"
                     ng-click="jumpToChapter(chapter.seconds)"
                     style="display: inline-block; cursor: pointer; width: 213px; flex-shrink: 0; padding: 12px; border: 1px solid #e1e8ed; border-radius: 8px; transition: all 0.2s ease; background-color: white;"
                     onmouseover="this.style.backgroundColor='#f8f9fa'; this.style.borderColor='#2196F3'; this.style.transform='translateY(-2px)';"
                     onmouseout="this.style.backgroundColor='white'; this.style.borderColor='#e1e8ed'; this.style.transform='translateY(0)';">
                  <!-- Chapter Thumbnail -->
                  <div class="chapter-thumbnail-main-horizontal" style="width: 189px; height: 106px; border-radius: 6px; overflow: hidden; background-color: #f5f5f5; margin-bottom: 8px; position: relative;">
                    <img ng-if="getChapterFrame(chapter)"
                         ng-src="/api/iiif/v2/{{ getChapterFrame(chapter).bucket_id }}:{{ getChapterFrame(chapter).version_id }}:{{ getChapterFrame(chapter).key }}/full/320,180/0/default.jpg"
                         style="width: 100%; height: 100%; object-fit: cover;"
                         alt="Chapter {{ chapter.timestamp }}"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div ng-if="!getChapterFrame(chapter)" 
                         style="width: 100%; height: 100%; background-color: #e9ecef; display: flex; align-items: center; justify-content: center;">
                      <i class="fa fa-film" style="color: #6c757d; font-size: 20px;"></i>
                    </div>
                    <!-- Timestamp overlay -->
                    <div style="position: absolute; bottom: 4px; right: 4px; background-color: rgba(0,0,0,0.8); color: white; padding: 2px 4px; border-radius: 2px; font-size: 11px; font-weight: 500;">
                      {{ chapter.timestamp }}
                    </div>
                  </div>
                  <!-- Chapter Info -->
                  <div class="chapter-info-main-horizontal">
                    <div style="font-size: 13px; font-weight: 600; line-height: 1.3; color: #333; overflow: hidden; text-overflow: ellipsis; white-space: normal; display: -webkit-box; -webkit-line-clamp: 2; line-clamp: 2; -webkit-box-orient: vertical; max-height: 2.6em;">
                      {{ cleanHtmlFromTitle(chapter.title) }}
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
          </div>
          <!-- /Chapters Section -->
          
          <!-- More -->
          <div class="cds-detail-more cds-detail-video-more px-20">
            <!-- Show Transcriptions -->
            <div class="mb-20"
                ng-show="(record.metadata._files | filter:{context_type:'subtitle', content_type:'vtt'}).length > 0" 
              >
              <hr />
              <div class="transcription-text">
                <h3><strong>Transcriptions</strong></h3>
                <small class="text-muted">Follow along or search within the transcript.</small>
              </div>

              <div class="transcription-button-wrapper pt-10">
                <button class="btn btn-sm btn-default transcription-button"
                        ng-click="toggleInThisVideo('transcript')">
                  {{ showInThisVideoSection ? 'Hide Transcriptions' : 'Show Transcriptions' }}
                </button>
              </div>
            </div>
            <!-- Show Transcriptions -->
            <ng-include src="'/static/templates/cds_records/keywords.html'"></ng-include>
            <ng-include 
              ng-if="(record.metadata.related_identifiers | filter:{scheme:'indico'}).length > 0" 
              src="'/static/templates/cds_records/video/related_event_section.html'">
            </ng-include>           
          </div>
          <!-- /More -->
        </div>
        <div class="cds-detail cds-detail-video cds-div-shadow bg-gl bt bw-1 bc-ccc pt-10 pb-20 px-20">
          <div class="cds-detail-title cds-detail-video-title">
            <h3 class="cds-title-section-decoration bt bw-1 pt-10 mb-20"><i class="fa fa-share"></i> Share</h3>
          </div>
          <ng-include src="'/static/templates/cds_records/video/share.html'"></ng-include>
        </div>
      </div>
      <!-- /Left Column -->
      <!-- Right Column -->
      <div class="col-md-4">        
        <!-- Section Download -->
        <div class="cds-detail cds-detail-video cds-div-shadow bg-w pt-10 px-20 pb-10 mb-30 mt-20 t-b">
          <ng-include src="'/static/templates/cds_records/video/downloads.html'"></ng-include>
        </div>
        <!-- /Section Download -->
        <!-- Section Technical Metadata -->
        <div class="cds-detail cds-detail-video cds-div-shadow bg-w pt-10 px-20 pb-10 mb-30 mt-20 t-b">
          <ng-include src="'/static/templates/cds_records/video/technical_metadata.html'"></ng-include>
        </div>
        <!-- /Section Technical Metadata -->
      </div>
      <!-- /Right Column -->
    </div>
  </div>
  <!-- /Metadata Section -->
</div>
